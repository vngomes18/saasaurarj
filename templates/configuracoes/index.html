{% extends "layout/base.html" %}

{% block title %}Configura√ß√µes - SaaS Sistema{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>
                
                Configura√ß√µes
            </h2>
            <p class="text-muted">Personalize sua experi√™ncia no sistema</p>
            <div class="mt-3">
                <span class="badge bg-primary me-2">
                    Usu√°rio
                </span>
                <span class="badge bg-info">
                    Personaliza√ß√£o
                </span>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                
                Voltar ao Dashboard
            </a>
        </div>
    </div>

    <!-- Configura√ß√µes Form -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <form method="POST" action="{{ url_for('atualizar_configuracoes') }}" class="needs-validation" novalidate>
                <!-- Apar√™ncia -->
                <div class="card settings-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            
                            Apar√™ncia
                        </h5>
                        <p class="text-muted mb-0">Configure a apar√™ncia da interface</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch d-flex align-items-center">
                                    <div class="flex-grow-1 me-3">
                                        <label class="form-check-label" for="dark_mode" style="cursor: pointer;">
                                            
                                            Modo Escuro
                                        </label>
                                        <div class="form-text">
                                            Ativa o tema escuro para reduzir o cansa√ßo visual
                                        </div>
                                    </div>
                                    <input class="form-check-input" type="checkbox" id="dark_mode" name="dark_mode" 
                                           {% if settings.dark_mode %}checked{% endif %}
                                           style="cursor: pointer; z-index: 1; position: relative; margin-left: auto;">
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch d-flex align-items-center">
                                    <div class="flex-grow-1 me-3">
                                        <label class="form-check-label" for="notifications" style="cursor: pointer;">
                                            
                                            Notifica√ß√µes
                                        </label>
                                        <div class="form-text">
                                            Receba notifica√ß√µes do sistema
                                        </div>
                                    </div>
                                    <input class="form-check-input" type="checkbox" id="notifications" name="notifications" 
                                           {% if settings.notifications %}checked{% endif %}
                                           style="cursor: pointer; z-index: 1; position: relative; margin-left: auto;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sistema -->
                <div class="card settings-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            
                            Sistema
                        </h5>
                        <p class="text-muted mb-0">Configure as prefer√™ncias do sistema</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="language" class="form-label">
                                    
                                    Idioma
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        
                                    </span>
                                    <select class="form-select" id="language" name="language">
                                        <option value="pt" {% if settings.language == 'pt' %}selected{% endif %}>üáßüá∑ Portugu√™s (Brasil)</option>
                                        <option value="en" {% if settings.language == 'en' %}selected{% endif %}>üá∫üá∏ English</option>
                                        <option value="es" {% if settings.language == 'es' %}selected{% endif %}>üá™üá∏ Espa√±ol</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="timezone" class="form-label">
                                    
                                    Fuso Hor√°rio
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        
                                    </span>
                                    <select class="form-select" id="timezone" name="timezone">
                                        <option value="America/Sao_Paulo" {% if settings.timezone == 'America/Sao_Paulo' %}selected{% endif %}>S√£o Paulo (UTC-3)</option>
                                        <option value="America/New_York" {% if settings.timezone == 'America/New_York' %}selected{% endif %}>New York (UTC-5)</option>
                                        <option value="Europe/London" {% if settings.timezone == 'Europe/London' %}selected{% endif %}>Londres (UTC+0)</option>
                                        <option value="Asia/Tokyo" {% if settings.timezone == 'Asia/Tokyo' %}selected{% endif %}>T√≥quio (UTC+9)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seguran√ßa -->
                <div class="card settings-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            
                            Seguran√ßa
                        </h5>
                        <p class="text-muted mb-0">Configure as op√ß√µes de seguran√ßa</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="auto_logout" class="form-label">
                                    
                                    Logout Autom√°tico
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        
                                    </span>
                                    <input type="number" class="form-control" id="auto_logout" name="auto_logout" 
                                           min="5" max="480" value="{{ settings.auto_logout }}">
                                    <span class="input-group-text">minutos</span>
                                </div>
                                <div class="form-text">
                                    Tempo de inatividade antes do logout autom√°tico
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dashboard_refresh" class="form-label">
                                    
                                    Atualiza√ß√£o do Dashboard
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        
                                    </span>
                                    <input type="number" class="form-control" id="dashboard_refresh" name="dashboard_refresh" 
                                           min="10" max="300" value="{{ settings.dashboard_refresh }}">
                                    <span class="input-group-text">segundos</span>
                                </div>
                                <div class="form-text">
                                    Intervalo de atualiza√ß√£o autom√°tica do dashboard
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary btn-lg">
                                        
                                        Cancelar
                                    </a>
                                    <button type="submit" class="btn btn-primary btn-lg px-4">
                                        
                                        Salvar Configura√ß√µes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Preview -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        
                        Pr√©-visualiza√ß√£o
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="avatar-lg bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3">
                            
                        </div>
                        <h6>{{ session.username }}</h6>
                        <p class="text-muted small">{{ session.empresa }}</p>
                    </div>
                    
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span>Modo Escuro</span>
                            <span class="badge bg-{% if settings.dark_mode %}success{% else %}secondary{% endif %}">
                                {% if settings.dark_mode %}Ativo{% else %}Inativo{% endif %}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span>Notifica√ß√µes</span>
                            <span class="badge bg-{% if settings.notifications %}success{% else %}secondary{% endif %}">
                                {% if settings.notifications %}Ativo{% else %}Inativo{% endif %}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span>Logout Auto</span>
                            <span class="badge bg-info">{{ settings.auto_logout }}min</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span>Atualiza√ß√£o</span>
                            <span class="badge bg-success">{{ settings.dashboard_refresh }}s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Garantir que os switches sejam clic√°veis
        const darkModeSwitch = document.getElementById('dark_mode');
        const notificationsSwitch = document.getElementById('notifications');
        
        if (darkModeSwitch) {
            darkModeSwitch.style.pointerEvents = 'auto';
            darkModeSwitch.style.cursor = 'pointer';
            darkModeSwitch.style.zIndex = '10';
            darkModeSwitch.style.position = 'relative';
        }
        
        if (notificationsSwitch) {
            notificationsSwitch.style.pointerEvents = 'auto';
            notificationsSwitch.style.cursor = 'pointer';
            notificationsSwitch.style.zIndex = '10';
            notificationsSwitch.style.position = 'relative';
        }

        // Atualizar preview em tempo real
        const form = document.querySelector('form');
        const previewElements = {
            dark_mode: document.querySelector('.list-group-item:nth-child(1) .badge'),
            notifications: document.querySelector('.list-group-item:nth-child(2) .badge'),
            auto_logout: document.querySelector('.list-group-item:nth-child(3) .badge'),
            dashboard_refresh: document.querySelector('.list-group-item:nth-child(4) .badge')
        };

        function updatePreview() {
            const darkModeCheck = document.getElementById('dark_mode');
            const notificationsCheck = document.getElementById('notifications');
            const autoLogoutInput = document.getElementById('auto_logout');
            const refreshInput = document.getElementById('dashboard_refresh');

            // Atualizar modo escuro
            if (previewElements.dark_mode && darkModeCheck) {
                previewElements.dark_mode.textContent = darkModeCheck.checked ? 'Ativo' : 'Inativo';
                previewElements.dark_mode.className = `badge bg-${darkModeCheck.checked ? 'success' : 'secondary'}`;
            }

            // Atualizar notifica√ß√µes
            if (previewElements.notifications && notificationsCheck) {
                previewElements.notifications.textContent = notificationsCheck.checked ? 'Ativo' : 'Inativo';
                previewElements.notifications.className = `badge bg-${notificationsCheck.checked ? 'success' : 'secondary'}`;
            }

            // Atualizar logout autom√°tico
            if (previewElements.auto_logout && autoLogoutInput) {
                previewElements.auto_logout.textContent = autoLogoutInput.value + 'min';
            }

            // Atualizar refresh
            if (previewElements.dashboard_refresh && refreshInput) {
                previewElements.dashboard_refresh.textContent = refreshInput.value + 's';
            }
        }

        // Adicionar event listeners com verifica√ß√£o
        if (darkModeSwitch) {
            darkModeSwitch.addEventListener('change', function(e) {
                console.log('Dark mode switch changed:', e.target.checked);
                updatePreview();
                
                // Aplicar dark mode globalmente usando a fun√ß√£o global
                if (typeof window.toggleGlobalDarkMode === 'function') {
                    window.toggleGlobalDarkMode();
                    console.log('Dark mode toggled globally');
                } else {
                    // Fallback se a fun√ß√£o global n√£o estiver dispon√≠vel
                    if (e.target.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('darkMode', 'true');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('darkMode', 'false');
                    }
                    console.log('Dark mode toggled with fallback');
                }
                
                // Salvar configura√ß√µes automaticamente
                saveSettings();
            });
            
            darkModeSwitch.addEventListener('click', function(e) {
                e.stopPropagation();
                console.log('Dark mode switch clicked');
            });
        }
        
        if (notificationsSwitch) {
            notificationsSwitch.addEventListener('change', updatePreview);
            notificationsSwitch.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        const autoLogoutInput = document.getElementById('auto_logout');
        const refreshInput = document.getElementById('dashboard_refresh');
        
        if (autoLogoutInput) {
            autoLogoutInput.addEventListener('input', updatePreview);
        }
        
        if (refreshInput) {
            refreshInput.addEventListener('input', updatePreview);
        }

        // Fun√ß√£o para salvar configura√ß√µes
        function saveSettings() {
            const form = document.querySelector('form[action*="atualizar_configuracoes"]');
            if (form) {
                const formData = new FormData(form);
                
                fetch('/configuracoes/atualizar', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        console.log('Settings saved successfully');
                        showToast('Configura√ß√µes salvas com sucesso!', 'success');
                        
                        // Sync dark mode state with localStorage
                        const darkModeEnabled = document.getElementById('dark_mode').checked;
                        localStorage.setItem('darkMode', darkModeEnabled.toString());
                        
                        // Notify other tabs about the change
                        localStorage.setItem('darkModeChanged', Date.now().toString());
                    } else {
                        console.error('Error saving settings');
                        showToast('Erro ao salvar configura√ß√µes', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Erro ao salvar configura√ß√µes', 'error');
                });
            }
        }
        
        // Fun√ß√£o para mostrar toast
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container') || createToastContainer();
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '1055';
            document.body.appendChild(container);
            return container;
        }

        // Atualiza√ß√£o inicial
        updatePreview();
        
        // Debug: verificar se os elementos existem
        console.log('Dark mode switch:', darkModeSwitch);
        console.log('Notifications switch:', notificationsSwitch);
    });
</script>
{% endblock %}
