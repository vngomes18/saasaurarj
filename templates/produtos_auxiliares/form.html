{% extends "layout/base.html" %}

{% block title %}
    {% if produto %}Editar Produto Auxiliar{% else %}Novo Produto Auxiliar{% endif %} - SaaS Sistema
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4 page-section-header align-items-center">
        <div class="col-md-8">
            <h2>
                
                {% if produto %}Editar Produto Auxiliar{% else %}Novo Produto Auxiliar{% endif %}
            </h2>
            <p class="text-muted">
                {% if produto %}Atualize as informa√ß√µes do produto auxiliar{% else %}Cadastre um novo produto auxiliar no sistema{% endif %}
            </p>
            <div class="mt-3">
                <span class="badge bg-primary me-2">
                    
                    {% if produto %}Edi√ß√£o{% else %}Cadastro{% endif %}
                </span>
                <span class="badge bg-info">
                    Auxiliar
                </span>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('produtos_auxiliares') }}" class="btn btn-outline-secondary">
                
                Voltar para Produtos Auxiliares
            </a>
        </div>
    </div>

    <!-- Form -->
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="POST" class="needs-validation" novalidate data-offline-queue="true">
                        <!-- CSRF Token -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <!-- Informa√ß√µes B√°sicas -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                
                                Informa√ß√µes B√°sicas
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="nome" class="form-label">
                                        
                                        Nome do Produto Auxiliar *
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            
                                        </span>
                                        <input type="text" 
                                               class="form-control" 
                                               id="nome" 
                                               name="nome" 
                                               placeholder="Ex: Parafuso M6 x 20mm"
                                               value="{{ produto.nome if produto else '' }}"
                                               required>
                                    </div>
                                    <div class="invalid-feedback">
                                        Por favor, insira o nome do produto auxiliar.
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="categoria" class="form-label">
                                        
                                        Categoria
                                    </label>
                                    <div class="categoria-autocomplete-container">
                                    <div class="input-group">
                                        <span class="input-group-text bg-info text-white">
                                            
                                        </span>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="categoria" 
                                                   name="categoria" 
                                                   value="{{ produto.categoria if produto else '' }}"
                                                   placeholder="Digite para buscar ou criar categoria..."
                                                   autocomplete="off">
                                            <button type="button" 
                                                    class="btn btn-outline-success" 
                                                    id="adicionar-nova-categoria"
                                                    title="Adicionar nova categoria">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                                </svg>
                                            </button>
                                        </div>
                                        
                                        <!-- Dropdown de sugest√µes -->
                                        <div id="categoria-suggestions" class="categoria-suggestions" style="display: none;">
                                            <!-- Sugest√µes ser√£o inseridas aqui via JavaScript -->
                                        </div>
                                        
                                        <!-- Modal para nova categoria -->
                                        <div class="modal fade" id="novaCategoriaModal" tabindex="-1" aria-labelledby="novaCategoriaModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-success text-white">
                                                        <h5 class="modal-title" id="novaCategoriaModalLabel">
                                                            
                                                            Nova Categoria
                                                        </h5>
                                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label for="nova-categoria-nome" class="form-label">
                                                                
                                                                Nome da Nova Categoria
                                                            </label>
                                                            <input type="text" 
                                                                   class="form-control form-control-lg" 
                                                                   id="nova-categoria-nome" 
                                                                   placeholder="Ex: Eletr√¥nicos, Roupas, etc."
                                                                   autocomplete="off">
                                                            <div class="form-text">
                                                                
                                                                Digite o nome da nova categoria que ser√° salva no sistema
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                                            </svg>
                                                            Cancelar
                                                        </button>
                                                        <button type="button" class="btn btn-success" id="salvar-nova-categoria">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                                                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                                                <polyline points="17,21 17,13 7,13 7,21"></polyline>
                                                                <polyline points="7,3 7,8 15,8"></polyline>
                                                            </svg>
                                                            Salvar Categoria
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-text">
                                        Digite para buscar categorias existentes ou crie uma nova
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="unidade" class="form-label">
                                        
                                        Unidade de Medida
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-warning text-white">
                                            
                                        </span>
                                        <select class="form-select" id="unidade" name="unidade">
                                            <option value="">Selecione a unidade</option>
                                            <option value="Unidade" {{ 'selected' if produto and produto.unidade == 'Unidade' else '' }}>üì¶ Unidade</option>
                                            <option value="kg" {{ 'selected' if produto and produto.unidade == 'kg' else '' }}>‚öñÔ∏è Quilograma (kg)</option>
                                            <option value="g" {{ 'selected' if produto and produto.unidade == 'g' else '' }}>‚öñÔ∏è Grama (g)</option>
                                            <option value="L" {{ 'selected' if produto and produto.unidade == 'L' else '' }}>ü•§ Litros (L)</option>
                                            <option value="m" {{ 'selected' if produto and produto.unidade == 'm' else '' }}>üìè Metros (m)</option>
                                            <option value="cm" {{ 'selected' if produto and produto.unidade == 'cm' else '' }}>üìè Cent√≠metros (cm)</option>
                                            <option value="Caixa" {{ 'selected' if produto and produto.unidade == 'Caixa' else '' }}>üì¶ Caixa</option>
                                            <option value="Pacote" {{ 'selected' if produto and produto.unidade == 'Pacote' else '' }}>üì¶ Pacote</option>
                                            <option value="Rolo" {{ 'selected' if produto and produto.unidade == 'Rolo' else '' }}>üßª Rolo</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Descri√ß√£o -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                
                                Descri√ß√£o
                            </h5>
                            <div class="mb-3">
                                <label for="descricao" class="form-label">
                                    
                                    Descri√ß√£o do Produto
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-secondary text-white">
                                        
                                    </span>
                                    <textarea class="form-control" 
                                              id="descricao" 
                                              name="descricao" 
                                              rows="3" 
                                              placeholder="Descreva o produto auxiliar...">{{ produto.descricao if produto else '' }}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Pre√ßo e Estoque -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                
                                Pre√ßo e Estoque
                            </h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="preco_unitario" class="form-label">
                                        
                                        Pre√ßo Unit√°rio *
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-success text-white">
                                            
                                        </span>
                                        <input type="text" 
                                               class="form-control currency-input" 
                                               id="preco_unitario" 
                                               name="preco_unitario" 
                                               placeholder="0,00"
                                               value="{% if produto and produto.preco_unitario %}{{ '%.2f'|format(produto.preco_unitario)|replace('.', ',') }}{% else %}0,00{% endif %}"
                                               required>
                                    </div>
                                    <div class="form-text">
                                        
                                        Pre√ßo por unidade do produto. Use v√≠rgula para centavos (ex: 0,50)
                                    </div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="estoque_atual" class="form-label">
                                        
                                        Estoque Atual
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-primary text-white">
                                            
                                        </span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="estoque_atual" 
                                               name="estoque_atual" 
                                               step="0.01" 
                                               min="0" 
                                               value="{{ produto.estoque_atual if produto else '0' }}"
                                               placeholder="0">
                                    </div>
                                    <div class="form-text">
                                        
                                        Quantidade atual em estoque
                                    </div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="estoque_minimo" class="form-label">
                                        
                                        Estoque M√≠nimo
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-warning text-white">
                                            
                                        </span>
                                        <input type="number" 
                                               class="form-control" 
                                               id="estoque_minimo" 
                                               name="estoque_minimo" 
                                               step="0.01" 
                                               min="0" 
                                               value="{{ produto.estoque_minimo if produto else '0' }}"
                                               placeholder="0">
                                    </div>
                                    <div class="form-text">
                                        
                                        Quantidade m√≠nima para alerta
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Se√ß√£o de Dados Fiscais -->
                        <div class="mb-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enable_fiscal_info" onchange="toggleSection('fiscal_info')">
                                        <label class="form-check-label fw-bold" for="enable_fiscal_info">
                                            Dados Fiscais do Produto
                                        </label>
                                        <small class="text-muted ms-3">(Opcional)</small>
                                    </div>
                                </div>
                                <div class="card-body" id="fiscal_info" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="nfe_numero" class="form-label">N√∫mero da NFe</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="nfe_numero" 
                                                   name="nfe_numero" 
                                                   placeholder="Ex: 123456789012345"
                                                   value="{{ produto.nfe_numero if produto else '' }}">
                                            <div class="form-text">N√∫mero da Nota Fiscal Eletr√¥nica</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="data_compra" class="form-label">Data da Compra</label>
                                            <input type="date" 
                                                   class="form-control" 
                                                   id="data_compra" 
                                                   name="data_compra" 
                                                   value="{{ produto.data_compra if produto else '' }}">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="cfop" class="form-label">CFOP</label>
                                            <div class="cfop-autocomplete-container">
                                                <div class="input-group">
                                                    <span class="input-group-text bg-info text-white">
                                                        <i class="fas fa-receipt"></i>
                                                    </span>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           id="cfop" 
                                                           name="cfop" 
                                                           placeholder="Digite para buscar ou criar CFOP..."
                                                           value="{{ produto.cfop if produto else '' }}"
                                                           autocomplete="off">
                                                    <button type="button" 
                                                            class="btn btn-outline-success" 
                                                            id="adicionar-novo-cfop"
                                                            title="Adicionar novo CFOP">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                                
                                                <!-- Dropdown de sugest√µes CFOP -->
                                                <div id="cfop-suggestions" class="cfop-suggestions" style="display: none;">
                                                    <!-- Sugest√µes ser√£o inseridas aqui via JavaScript -->
                                                </div>
                                                
                                                <!-- Modal para novo CFOP -->
                                                <div class="modal fade" id="novoCfopModal" tabindex="-1" aria-labelledby="novoCfopModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">
                                                        <div class="modal-content">
                                                            <div class="modal-header bg-success text-white">
                                                                <h5 class="modal-title" id="novoCfopModalLabel">
                                                                    <i class="fas fa-receipt me-2"></i>
                                                                    Novo CFOP
                                                                </h5>
                                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="mb-3">
                                                                    <label for="novo-cfop-codigo" class="form-label">
                                                                        <i class="fas fa-hashtag me-1"></i>
                                                                        C√≥digo do CFOP
                                                                    </label>
                                                                    <input type="text" 
                                                                           class="form-control form-control-lg" 
                                                                           id="novo-cfop-codigo" 
                                                                           placeholder="Ex: 1102"
                                                                           autocomplete="off">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="novo-cfop-descricao" class="form-label">
                                                                        <i class="fas fa-align-left me-1"></i>
                                                                        Descri√ß√£o do CFOP
                                                                    </label>
                                                                    <input type="text" 
                                                                           class="form-control form-control-lg" 
                                                                           id="novo-cfop-descricao" 
                                                                           placeholder="Ex: Compra para comercializa√ß√£o"
                                                                           autocomplete="off">
                                                                    <div class="form-text">
                                                                        <i class="fas fa-info-circle me-1"></i>
                                                                        Digite o c√≥digo e descri√ß√£o do novo CFOP
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                                    <i class="fas fa-times me-1"></i>
                                                                    Cancelar
                                                                </button>
                                                                <button type="button" class="btn btn-success" id="salvar-novo-cfop">
                                                                    <i class="fas fa-save me-1"></i>
                                                                    Salvar CFOP
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Digite para buscar CFOPs existentes ou crie um novo
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="ncm" class="form-label">NCM</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="ncm" 
                                                   name="ncm" 
                                                   placeholder="Ex: 12345678"
                                                   value="{{ produto.ncm if produto else '' }}">
                                            <div class="form-text">C√≥digo NCM (Nomenclatura Comum do Mercosul)</div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="cst" class="form-label">CST</label>
                                            <div class="cst-autocomplete-container">
                                                <div class="input-group">
                                                    <span class="input-group-text bg-warning text-white">
                                                        <i class="fas fa-percentage"></i>
                                                    </span>
                                                    <input type="text" 
                                                           class="form-control" 
                                                           id="cst" 
                                                           name="cst" 
                                                           placeholder="Digite para buscar ou criar CST..."
                                                           value="{{ produto.cst if produto else '' }}"
                                                           autocomplete="off">
                                                    <button type="button" 
                                                            class="btn btn-outline-success" 
                                                            id="adicionar-novo-cst"
                                                            title="Adicionar novo CST">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                                
                                                <!-- Dropdown de sugest√µes CST -->
                                                <div id="cst-suggestions" class="cst-suggestions" style="display: none;">
                                                    <!-- Sugest√µes ser√£o inseridas aqui via JavaScript -->
                                                </div>
                                                
                                                <!-- Modal para novo CST -->
                                                <div class="modal fade" id="novoCstModal" tabindex="-1" aria-labelledby="novoCstModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">
                                                        <div class="modal-content">
                                                            <div class="modal-header bg-success text-white">
                                                                <h5 class="modal-title" id="novoCstModalLabel">
                                                                    <i class="fas fa-percentage me-2"></i>
                                                                    Novo CST
                                                                </h5>
                                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="mb-3">
                                                                    <label for="novo-cst-codigo" class="form-label">
                                                                        <i class="fas fa-hashtag me-1"></i>
                                                                        C√≥digo do CST
                                                                    </label>
                                                                    <input type="text" 
                                                                           class="form-control form-control-lg" 
                                                                           id="novo-cst-codigo" 
                                                                           placeholder="Ex: 00"
                                                                           autocomplete="off">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="novo-cst-descricao" class="form-label">
                                                                        <i class="fas fa-align-left me-1"></i>
                                                                        Descri√ß√£o do CST
                                                                    </label>
                                                                    <input type="text" 
                                                                           class="form-control form-control-lg" 
                                                                           id="novo-cst-descricao" 
                                                                           placeholder="Ex: Tributada integralmente"
                                                                           autocomplete="off">
                                                                    <div class="form-text">
                                                                        <i class="fas fa-info-circle me-1"></i>
                                                                        Digite o c√≥digo e descri√ß√£o do novo CST
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                                    <i class="fas fa-times me-1"></i>
                                                                    Cancelar
                                                                </button>
                                                                <button type="button" class="btn btn-success" id="salvar-novo-cst">
                                                                    <i class="fas fa-save me-1"></i>
                                                                    Salvar CST
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Digite para buscar CSTs existentes ou crie um novo
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="aliquota_icms" class="form-label">Al√≠quota ICMS (%)</label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="aliquota_icms" 
                                                   name="aliquota_icms" 
                                                   step="0.01"
                                                   min="0"
                                                   max="100"
                                                   placeholder="Ex: 18.00"
                                                   value="{{ produto.aliquota_icms if produto else '' }}">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="valor_icms" class="form-label">Valor do ICMS (R$)</label>
                                            <input type="text" 
                                                   class="form-control currency-input" 
                                                   id="valor_icms" 
                                                   name="valor_icms" 
                                                   placeholder="0,00"
                                                   value="{{ produto.valor_icms|string|replace('.', ',') if produto and produto.valor_icms else '' }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="valor_ipi" class="form-label">Valor do IPI (R$)</label>
                                            <input type="text" 
                                                   class="form-control currency-input" 
                                                   id="valor_ipi" 
                                                   name="valor_ipi" 
                                                   placeholder="0,00"
                                                   value="{{ produto.valor_ipi|string|replace('.', ',') if produto and produto.valor_ipi else '' }}">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="observacoes_fiscais" class="form-label">Observa√ß√µes Fiscais</label>
                                            <textarea class="form-control" 
                                                      id="observacoes_fiscais" 
                                                      name="observacoes_fiscais" 
                                                      rows="3" 
                                                      placeholder="Observa√ß√µes importantes sobre aspectos fiscais do produto">{{ produto.observacoes_fiscais if produto else '' }}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Se√ß√£o de Fornecedor -->
                        <div class="mb-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enable_supplier_info" onchange="toggleSection('supplier_info')">
                                        <label class="form-check-label fw-bold" for="enable_supplier_info">
                                            Informa√ß√µes do Fornecedor
                                        </label>
                                        <small class="text-muted ms-3">(Opcional)</small>
                                    </div>
                                </div>
                                <div class="card-body" id="supplier_info" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="fornecedor_nome" class="form-label">Nome do Fornecedor</label>
                                            <div class="fornecedor-autocomplete-container">
                                                <div class="input-group">
                                                    <span class="input-group-text bg-info text-white">
                                                        <i class="fas fa-building"></i>
                                                    </span>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="fornecedor_nome" 
                                                   name="fornecedor_nome" 
                                                           placeholder="Digite para buscar ou criar fornecedor..."
                                                           value="{{ produto.fornecedor_nome if produto else '' }}"
                                                           autocomplete="off">
                                                    <button type="button" 
                                                            class="btn btn-outline-success" 
                                                            id="adicionar-novo-fornecedor"
                                                            title="Adicionar novo fornecedor">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                                
                                                <!-- Dropdown de sugest√µes Fornecedor -->
                                                <div id="fornecedor-suggestions" class="fornecedor-suggestions" style="display: none;">
                                                    <!-- Sugest√µes ser√£o inseridas aqui via JavaScript -->
                                                </div>
                                                
                                                <!-- Modal para novo Fornecedor -->
                                                <div class="modal fade" id="novoFornecedorModal" tabindex="-1" aria-labelledby="novoFornecedorModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">
                                                        <div class="modal-content">
                                                            <div class="modal-header bg-success text-white">
                                                                <h5 class="modal-title" id="novoFornecedorModalLabel">
                                                                    <i class="fas fa-building me-2"></i>
                                                                    Novo Fornecedor
                                                                </h5>
                                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="mb-3">
                                                                    <label for="novo-fornecedor-nome" class="form-label">
                                                                        <i class="fas fa-building me-1"></i>
                                                                        Nome do Fornecedor
                                                                    </label>
                                                                    <input type="text" 
                                                                           class="form-control form-control-lg" 
                                                                           id="novo-fornecedor-nome" 
                                                                           placeholder="Ex: Empresa ABC Ltda"
                                                                           autocomplete="off">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="novo-fornecedor-cnpj" class="form-label">
                                                                        <i class="fas fa-id-card me-1"></i>
                                                                        CNPJ
                                                                    </label>
                                                                    <input type="text" 
                                                                           class="form-control form-control-lg cnpj-input" 
                                                                           id="novo-fornecedor-cnpj" 
                                                                           placeholder="00.000.000/0000-00"
                                                                           autocomplete="off">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="novo-fornecedor-contato" class="form-label">
                                                                        <i class="fas fa-user me-1"></i>
                                                                        Pessoa de Contato
                                                                    </label>
                                                                    <input type="text" 
                                                                           class="form-control form-control-lg" 
                                                                           id="novo-fornecedor-contato" 
                                                                           placeholder="Ex: Jo√£o Silva"
                                                                           autocomplete="off">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="novo-fornecedor-telefone" class="form-label">
                                                                        <i class="fas fa-phone me-1"></i>
                                                                        Telefone
                                                                    </label>
                                                                    <input type="text" 
                                                                           class="form-control form-control-lg phone-input" 
                                                                           id="novo-fornecedor-telefone" 
                                                                           placeholder="(00) 00000-0000"
                                                                           autocomplete="off">
                                                                </div>
                                                                <div class="mb-3">
                                                                    <label for="novo-fornecedor-email" class="form-label">
                                                                        <i class="fas fa-envelope me-1"></i>
                                                                        E-mail
                                                                    </label>
                                                                    <input type="email" 
                                                                           class="form-control form-control-lg" 
                                                                           id="novo-fornecedor-email" 
                                                                           placeholder="contato@empresa.com"
                                                                           autocomplete="off">
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                                    <i class="fas fa-times me-1"></i>
                                                                    Cancelar
                                                                </button>
                                                                <button type="button" class="btn btn-success" id="salvar-novo-fornecedor">
                                                                    <i class="fas fa-save me-1"></i>
                                                                    Salvar Fornecedor
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-text">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Digite para buscar fornecedores existentes ou crie um novo
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="fornecedor_cnpj" class="form-label">CNPJ do Fornecedor</label>
                                            <input type="text" 
                                                   class="form-control cnpj-input" 
                                                   id="fornecedor_cnpj" 
                                                   name="fornecedor_cnpj" 
                                                   placeholder="00.000.000/0000-00"
                                                   value="{{ produto.fornecedor_cnpj if produto else '' }}">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="fornecedor_contato" class="form-label">Pessoa de Contato</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="fornecedor_contato" 
                                                   name="fornecedor_contato" 
                                                   placeholder="Nome do representante"
                                                   value="{{ produto.fornecedor_contato if produto else '' }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="fornecedor_telefone" class="form-label">Telefone</label>
                                            <input type="text" 
                                                   class="form-control phone-input" 
                                                   id="fornecedor_telefone" 
                                                   name="fornecedor_telefone" 
                                                   placeholder="(00) 00000-0000"
                                                   value="{{ produto.fornecedor_telefone if produto else '' }}">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="fornecedor_email" class="form-label">E-mail</label>
                                            <input type="email" 
                                                   class="form-control" 
                                                   id="fornecedor_email" 
                                                   name="fornecedor_email" 
                                                   placeholder="contato@fornecedor.com"
                                                   value="{{ produto.fornecedor_email if produto else '' }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="preco_compra" class="form-label">Pre√ßo de Compra</label>
                                            <input type="text" 
                                                   class="form-control currency-input" 
                                                   id="preco_compra" 
                                                   name="preco_compra" 
                                                   placeholder="0,00"
                                                   value="{{ produto.preco_compra|string|replace('.', ',') if produto and produto.preco_compra else '' }}">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="prazo_entrega" class="form-label">Prazo de Entrega</label>
                                            <select class="form-select" id="prazo_entrega" name="prazo_entrega">
                                                <option value="">Selecione...</option>
                                                <option value="imediato" {{ 'selected' if produto and produto.prazo_entrega == 'imediato' else '' }}>Imediato</option>
                                                <option value="1-3_dias" {{ 'selected' if produto and produto.prazo_entrega == '1-3_dias' else '' }}>1-3 dias</option>
                                                <option value="3-7_dias" {{ 'selected' if produto and produto.prazo_entrega == '3-7_dias' else '' }}>3-7 dias</option>
                                                <option value="7-15_dias" {{ 'selected' if produto and produto.prazo_entrega == '7-15_dias' else '' }}>7-15 dias</option>
                                                <option value="15-30_dias" {{ 'selected' if produto and produto.prazo_entrega == '15-30_dias' else '' }}>15-30 dias</option>
                                                <option value="30+_dias" {{ 'selected' if produto and produto.prazo_entrega == '30+_dias' else '' }}>30+ dias</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="fornecedor_endereco" class="form-label">Endere√ßo do Fornecedor</label>
                                            <textarea class="form-control" 
                                                      id="fornecedor_endereco" 
                                                      name="fornecedor_endereco" 
                                                      rows="2" 
                                                      placeholder="Endere√ßo completo do fornecedor">{{ produto.fornecedor_endereco if produto else '' }}</textarea>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="observacoes_fornecedor" class="form-label">Observa√ß√µes sobre o Fornecedor</label>
                                            <textarea class="form-control" 
                                                      id="observacoes_fornecedor" 
                                                      name="observacoes_fornecedor" 
                                                      rows="2" 
                                                      placeholder="Observa√ß√µes importantes sobre o fornecedor">{{ produto.observacoes_fornecedor if produto else '' }}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="mb-4">
                            <h5 class="text-primary mb-3">
                                
                                Observa√ß√µes
                            </h5>
                            <div class="mb-3">
                                <label for="observacoes" class="form-label">
                                    
                                    Observa√ß√µes Adicionais
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-info text-white">
                                        
                                    </span>
                                    <textarea class="form-control" 
                                              id="observacoes" 
                                              name="observacoes" 
                                              rows="3" 
                                              placeholder="Observa√ß√µes importantes sobre o produto...">{{ produto.observacoes if produto else '' }}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Bot√µes -->
                        <div class="d-flex justify-content-end gap-3">
                            <a href="{{ url_for('produtos_auxiliares') }}" class="btn btn-outline-secondary">
                                
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                
                                {{ 'Atualizar' if produto else 'Cadastrar' }} Produto Auxiliar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        
    </div>
</div>

<!-- Modal para Nova Categoria -->
<div class="modal fade" id="novaCategoriaModal" tabindex="-1" aria-labelledby="novaCategoriaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="novaCategoriaModalLabel">
                    
                    Nova Categoria
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="novaCategoriaForm">
                    <div class="mb-3">
                        <label for="nova-categoria-nome" class="form-label">
                            
                            Nome da Categoria
                        </label>
                        <input type="text" class="form-control" id="nova-categoria-nome" 
                               placeholder="Ex: Ferramentas, Materiais, etc." required>
                        <div class="form-text">
                            Digite o nome da nova categoria para produtos auxiliares
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="salvar-nova-categoria">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-1">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17,21 17,13 7,13 7,21"></polyline>
                        <polyline points="7,3 7,8 15,8"></polyline>
                    </svg>
                    Salvar Categoria
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.categoria-autocomplete-container,
.cfop-autocomplete-container,
.cst-autocomplete-container,
.fornecedor-autocomplete-container {
    position: relative;
}

.categoria-suggestions,
.cfop-suggestions,
.cst-suggestions,
.fornecedor-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
}

.suggestion-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    display: flex;
    align-items: center;
    transition: background-color 0.15s ease-in-out;
}

.suggestion-item:hover {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-item .suggestion-icon {
    margin-right: 0.5rem;
    color: #6c757d;
    width: 16px;
}

.suggestion-item.selected {
    background-color: #e3f2fd;
    color: #1976d2;
}

.suggestion-item.new-category {
    background-color: #f8f9fa;
    font-style: italic;
    color: #28a745;
}

.suggestion-item.new-category .suggestion-icon {
    color: #28a745;
}

.no-suggestions {
    padding: 0.75rem 1rem;
    color: #6c757d;
    font-style: italic;
    text-align: center;
}

.suggestion-highlight {
    background-color: #fff3cd;
    font-weight: 600;
}

/* Modal espec√≠fico para nova categoria */
#novaCategoriaModal {
    z-index: 9999 !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0, 0, 0, 0.5) !important;
}

#novaCategoriaModal .modal-backdrop {
    z-index: 9998 !important;
    background: rgba(0, 0, 0, 0.5) !important;
}

#novaCategoriaModal .btn {
    pointer-events: auto !important;
    z-index: 100003 !important;
}

#novaCategoriaModal input {
    pointer-events: auto !important;
    z-index: 100003 !important;
}

#novaCategoriaModal .modal-content {
    position: relative !important;
    z-index: 10000 !important;
}

#novaCategoriaModal .modal-header,
#novaCategoriaModal .modal-body,
#novaCategoriaModal .modal-footer {
    position: relative !important;
    z-index: 10001 !important;
}
</style>

<script>
// Fun√ß√£o para alternar se√ß√µes colaps√°veis
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        if (section.style.display === 'none' || section.style.display === '') {
            section.style.display = 'block';
            section.style.opacity = '0';
            setTimeout(() => {
                section.style.opacity = '1';
            }, 10);
        } else {
            section.style.opacity = '0';
            setTimeout(() => {
                section.style.display = 'none';
            }, 300);
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Verificar se h√° dados existentes na se√ß√£o de dados fiscais e habilit√°-la automaticamente
    const fiscalSection = document.getElementById('fiscal_info');
    const fiscalCheckbox = document.getElementById('enable_fiscal_info');
    
    if (fiscalSection && fiscalCheckbox) {
        // Verificar se h√° campos preenchidos na se√ß√£o
        const inputs = fiscalSection.querySelectorAll('input, select, textarea');
        let hasData = false;
        
        inputs.forEach(input => {
            if (input.type === 'checkbox') {
                if (input.checked) hasData = true;
            } else if (input.type === 'radio') {
                if (input.checked) hasData = true;
            } else if (input.value && input.value.trim() !== '') {
                hasData = true;
            }
        });
        
        if (hasData) {
            fiscalCheckbox.checked = true;
            fiscalSection.style.display = 'block';
            fiscalSection.style.opacity = '1';
        }
    }

    // Verificar se h√° dados existentes na se√ß√£o de fornecedor e habilit√°-la automaticamente
    const supplierSection = document.getElementById('supplier_info');
    const supplierCheckbox = document.getElementById('enable_supplier_info');
    
    if (supplierSection && supplierCheckbox) {
        // Verificar se h√° campos preenchidos na se√ß√£o
        const inputs = supplierSection.querySelectorAll('input, select, textarea');
        let hasData = false;
        
        inputs.forEach(input => {
            if (input.type === 'checkbox') {
                if (input.checked) hasData = true;
            } else if (input.type === 'radio') {
                if (input.checked) hasData = true;
            } else if (input.value && input.value.trim() !== '') {
                hasData = true;
            }
        });
        
        if (hasData) {
            supplierCheckbox.checked = true;
            supplierSection.style.display = 'block';
            supplierSection.style.opacity = '1';
        }
    }
    // Elementos do DOM
    const categoriaInput = document.getElementById('categoria');
    const categoriaSuggestions = document.getElementById('categoria-suggestions');
    const adicionarNovaCategoriaBtn = document.getElementById('adicionar-nova-categoria');
    const novaCategoriaModal = new bootstrap.Modal(document.getElementById('novaCategoriaModal'));
    const novaCategoriaNomeInput = document.getElementById('nova-categoria-nome');
    const salvarNovaCategoriaBtn = document.getElementById('salvar-nova-categoria');
    
    // Categorias padr√£o para produtos auxiliares
    let categoriasExistentes = [
        'Ferramentas', 'Materiais', 'Insumos', 'Equipamentos', 
        'Limpeza', 'Seguran√ßa', 'Manuten√ß√£o', 'Escrit√≥rio', 'Outros'
    ];
    
    // Carregar categorias dinamicamente do backend
    async function carregarCategorias() {
        try {
            const response = await fetch('/api/categorias');
            if (response.ok) {
                const categoriasBackend = await response.json();
                // Adicionar categorias do backend sem duplicar
                categoriasBackend.forEach(categoria => {
                    if (!categoriasExistentes.includes(categoria)) {
                        categoriasExistentes.push(categoria);
                    }
                });
            }
        } catch (error) {
            console.log('Erro ao carregar categorias do backend:', error);
        }
    }
    
    // Carregar categorias ao inicializar
    carregarCategorias();
    
    // Sistema de Autocomplete para Fornecedores
    const fornecedorInput = document.getElementById('fornecedor_nome');
    const fornecedorSuggestionsContainer = document.getElementById('fornecedor-suggestions');
    const adicionarNovoFornecedorBtn = document.getElementById('adicionar-novo-fornecedor');
    const novoFornecedorModal = new bootstrap.Modal(document.getElementById('novoFornecedorModal'));
    const novoFornecedorNome = document.getElementById('novo-fornecedor-nome');
    const novoFornecedorCnpj = document.getElementById('novo-fornecedor-cnpj');
    const novoFornecedorContato = document.getElementById('novo-fornecedor-contato');
    const novoFornecedorTelefone = document.getElementById('novo-fornecedor-telefone');
    const novoFornecedorEmail = document.getElementById('novo-fornecedor-email');
    const salvarNovoFornecedorBtn = document.getElementById('salvar-novo-fornecedor');
    
    // Lista de fornecedores existentes (ser√° carregada do backend)
    let fornecedoresExistentes = [];
    
    // Carregar fornecedores do backend
    async function carregarFornecedores() {
        try {
            const response = await fetch('/api/fornecedores');
            if (response.ok) {
                const fornecedores = await response.json();
                fornecedoresExistentes = fornecedores.map(f => f.nome);
            }
        } catch (error) {
            console.log('Erro ao carregar fornecedores do backend:', error);
        }
    }
    
    // Carregar fornecedores ao inicializar
    carregarFornecedores();
    
    // Sistema de Autocomplete para CFOP
    const cfopInput = document.getElementById('cfop');
    const cfopSuggestionsContainer = document.getElementById('cfop-suggestions');
    const adicionarNovoCfopBtn = document.getElementById('adicionar-novo-cfop');
    const novoCfopModal = new bootstrap.Modal(document.getElementById('novoCfopModal'));
    const novoCfopCodigo = document.getElementById('novo-cfop-codigo');
    const novoCfopDescricao = document.getElementById('novo-cfop-descricao');
    const salvarNovoCfopBtn = document.getElementById('salvar-novo-cfop');
    
    // Lista de CFOPs existentes
    let cfopsExistentes = [
        '1102 - Compra para comercializa√ß√£o',
        '1101 - Compra para industrializa√ß√£o',
        '1202 - Devolu√ß√£o de venda',
        '1403 - Compra para comercializa√ß√£o em opera√ß√£o com ST',
        '1949 - Outras entradas n√£o especificadas',
        '5102 - Venda de mercadoria adquirida ou recebida com entrada',
        '5101 - Venda de mercadoria adquirida ou recebida com entrada',
        '6102 - Devolu√ß√£o de compra para comercializa√ß√£o',
        '6101 - Devolu√ß√£o de compra para industrializa√ß√£o'
    ];
    
    // Sistema de Autocomplete para CST
    const cstInput = document.getElementById('cst');
    const cstSuggestionsContainer = document.getElementById('cst-suggestions');
    const adicionarNovoCstBtn = document.getElementById('adicionar-novo-cst');
    const novoCstModal = new bootstrap.Modal(document.getElementById('novoCstModal'));
    const novoCstCodigo = document.getElementById('novo-cst-codigo');
    const novoCstDescricao = document.getElementById('novo-cst-descricao');
    const salvarNovoCstBtn = document.getElementById('salvar-novo-cst');
    
    // Lista de CSTs existentes
    let cstsExistentes = [
        '00 - Tributada integralmente',
        '10 - Tributada e com cobran√ßa do ICMS por ST',
        '20 - Com redu√ß√£o de base de c√°lculo',
        '30 - Isenta ou n√£o tributada e com cobran√ßa do ICMS por ST',
        '40 - Isenta',
        '41 - N√£o tributada',
        '50 - Suspens√£o',
        '51 - Diferimento',
        '60 - ICMS cobrado anteriormente por ST',
        '70 - Com redu√ß√£o de base de c√°lculo e cobran√ßa do ICMS por ST',
        '90 - Outras'
    ];
    
    // Fun√ß√£o para formatar campo de pre√ßo
    function formatPriceField(input) {
        if (!input) return;
        
        input.addEventListener('input', function() {
            let value = this.value;
            
            // Remove tudo exceto n√∫meros e v√≠rgula
            value = value.replace(/[^\d,]/g, '');
            
            // Garantir apenas uma v√≠rgula
            const commaCount = (value.match(/,/g) || []).length;
            if (commaCount > 1) {
                value = value.replace(/,/g, '');
                value = value.replace(/(\d{2})$/, ',$1');
            }
            
            // Limitar a 2 casas decimais ap√≥s a v√≠rgula
            const parts = value.split(',');
            if (parts[1] && parts[1].length > 2) {
                parts[1] = parts[1].substring(0, 2);
                value = parts.join(',');
            }
            
            this.value = value;
        });
        
        // Permitir navega√ß√£o e edi√ß√£o adequada
        input.addEventListener('keydown', function(e) {
            // Permitir: backspace, delete, tab, escape, enter, arrow keys, home, end
            if ([8, 46, 9, 27, 13, 35, 36, 37, 38, 39, 40].includes(e.keyCode) ||
                // Permitir: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.ctrlKey === true && ['a', 'c', 'v', 'x'].includes(e.key.toLowerCase()))) {
                return; // Let it happen, do not prevent
            }
            
            // Permitir n√∫meros e v√≠rgula
            if (!((e.keyCode >= 48 && e.keyCode <= 57) || // numbers 0-9
                  (e.keyCode >= 96 && e.keyCode <= 105) || // numpad numbers 0-9
                  (e.key === ',' && !this.value.includes(',')))) { // only one comma
                e.preventDefault();
            }
        });
    }
    
    // Aplicar formata√ß√£o ao campo de pre√ßo
    const precoInput = document.getElementById('preco_unitario');
    if (precoInput) {
        formatPriceField(precoInput);
    }
    
    // Aplicar formata√ß√£o de moeda para todos os campos currency-input
    document.querySelectorAll('.currency-input').forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value;
            
            // Remove tudo exceto n√∫meros e v√≠rgula
            value = value.replace(/[^\d,]/g, '');
            
            // Garantir apenas uma v√≠rgula
            const commaCount = (value.match(/,/g) || []).length;
            if (commaCount > 1) {
                value = value.replace(/,/g, '');
                value = value.replace(/(\d{2})$/, ',$1');
            }
            
            // Limitar a 2 casas decimais ap√≥s a v√≠rgula
            const parts = value.split(',');
            if (parts[1] && parts[1].length > 2) {
                parts[1] = parts[1].substring(0, 2);
                value = parts.join(',');
            }
            
            e.target.value = value;
        });
    });
    
    // Fun√ß√£o para mostrar sugest√µes de categoria
    function showCategoriaSuggestions(query) {
        let regularSuggestions = [];
        
        // Se n√£o h√° query ou query vazia, mostrar todas as categorias
        if (!query || query.length < 1) {
            regularSuggestions = categoriasExistentes.filter(categoria => categoria !== 'Outros');
        } else {
            // Filtrar categorias que correspondem √† query
            regularSuggestions = categoriasExistentes
                .filter(categoria => categoria !== 'Outros') // Remover "Outros" da lista normal
                .filter(categoria => categoria.toLowerCase().includes(query.toLowerCase()));
        }
        
        // Montar lista final com ordem espec√≠fica
        let finalSuggestions = [...regularSuggestions];
        
        // Verificar se "Outros" deve aparecer (se corresponde √† query ou se n√£o h√° query)
        const shouldShowOutros = !query || 'outros'.includes(query.toLowerCase()) || query.toLowerCase().includes('outros');
        
        // Adicionar "Outros" em antepen√∫ltimo (se deve aparecer)
        if (shouldShowOutros) {
            finalSuggestions.push('Outros');
        }
        
        // Sempre adicionar "Criar nova categoria" por √∫ltimo
        if (!query || query.length < 1) {
            finalSuggestions.push('Criar nova categoria...');
        } else {
            // Se h√° query, sempre permitir criar nova categoria
            finalSuggestions.push(`Criar "${query}"`);
        }
        
        // Se n√£o h√° sugest√µes regulares e n√£o deve mostrar "Outros", mostrar mensagem
        if (finalSuggestions.length === 1 && finalSuggestions[0].startsWith('Criar')) {
            categoriaSuggestions.innerHTML = `
                <div class="categoria-suggestion text-muted">
                    
                    Nenhuma categoria encontrada
                </div>
                <div class="categoria-suggestion categoria-criar" data-categoria="${query}">
                    
                    ${finalSuggestions[0]}
                </div>
            `;
        } else {
            categoriaSuggestions.innerHTML = finalSuggestions.map(cat => {
                const isCriar = cat.startsWith('Criar');
                return `
                    <div class="categoria-suggestion ${isCriar ? 'categoria-criar' : ''}" data-categoria="${isCriar ? (cat.includes('"') ? cat.match(/"([^"]+)"/)[1] : '') : cat}">
                        
                        ${cat}
                    </div>
                `;
            }).join('');
        }
        
        // Adicionar event listeners √†s sugest√µes
        categoriaSuggestions.querySelectorAll('.categoria-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', function() {
                if (this.classList.contains('categoria-criar')) {
                    // Se √© "criar nova categoria", abrir modal
                    const novaCategoria = this.dataset.categoria;
                    if (novaCategoria) {
                        novaCategoriaNomeInput.value = novaCategoria;
                    }
                    novaCategoriaModal.show();
                } else if (!this.classList.contains('text-muted')) {
                    // Se √© categoria normal, selecionar
                    categoriaInput.value = this.dataset.categoria;
                    categoriaSuggestions.style.display = 'none';
                    categoriaInput.focus();
                }
            });
        });
        
        categoriaSuggestions.style.display = 'block';
    }
    
    // Event listeners para categoria
    if (categoriaInput) {
        categoriaInput.addEventListener('input', function() {
            showCategoriaSuggestions(this.value);
        });
        
        categoriaInput.addEventListener('focus', function() {
            showCategoriaSuggestions(this.value);
        });
        
        categoriaInput.addEventListener('blur', function() {
            // Delay para permitir cliques nas sugest√µes
            setTimeout(() => {
                categoriaSuggestions.style.display = 'none';
            }, 200);
        });
    }
    
    // Event listener para esconder sugest√µes ao clicar fora
    document.addEventListener('click', function(e) {
        if (!categoriaInput.contains(e.target) && !categoriaSuggestions.contains(e.target) && !e.target.closest('.modal')) {
            categoriaSuggestions.style.display = 'none';
        }
        if (!fornecedorInput.contains(e.target) && !fornecedorSuggestionsContainer.contains(e.target) && !e.target.closest('.modal')) {
            fornecedorSuggestionsContainer.style.display = 'none';
        }
        if (!cfopInput.contains(e.target) && !cfopSuggestionsContainer.contains(e.target) && !e.target.closest('.modal')) {
            cfopSuggestionsContainer.style.display = 'none';
        }
        if (!cstInput.contains(e.target) && !cstSuggestionsContainer.contains(e.target) && !e.target.closest('.modal')) {
            cstSuggestionsContainer.style.display = 'none';
        }
    });
    
    // ===== SISTEMA DE AUTOCOMPLETE PARA CFOP =====
    let cfopSelectedIndex = -1;
    let cfopSuggestions = [];

    // Fun√ß√£o para mostrar sugest√µes CFOP
    function showCfopSuggestions(query) {
        if (!query || query.length < 1) {
            cfopSuggestions = cfopsExistentes.map(cfop => ({
                text: cfop,
                isNew: false,
                originalText: cfop
            }));
            cfopSuggestions.push({
                text: 'Criar novo CFOP...',
                isNew: true,
                originalText: ''
            });
        } else {
            const filteredCfops = cfopsExistentes.filter(cfop => 
                cfop.toLowerCase().includes(query.toLowerCase())
            );
            
            cfopSuggestions = filteredCfops.map(cfop => ({
                text: cfop,
                isNew: false,
                originalText: cfop
            }));
            
            if (cfopSuggestions.length === 0) {
                cfopSuggestions = [{
                    text: `Criar "${query}"`,
                    isNew: true,
                    originalText: query
                }];
            } else {
                cfopSuggestions.push({
                    text: `Criar "${query}"`,
                    isNew: true,
                    originalText: query
                });
            }
        }
        
        renderCfopSuggestions();
        showCfopSuggestionsContainer();
    }

    // Fun√ß√£o para renderizar sugest√µes CFOP
    function renderCfopSuggestions() {
        cfopSuggestionsContainer.innerHTML = '';
        
        cfopSuggestions.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'cfop-suggestion';
            item.dataset.index = index;
            
            const icon = document.createElement('i');
            icon.className = suggestion.isNew ? 'fas fa-plus me-2' : 'fas fa-receipt me-2';
            
            const text = document.createElement('span');
            text.textContent = suggestion.text;
            
            item.appendChild(icon);
            item.appendChild(text);
            
            if (suggestion.isNew) {
                item.style.fontStyle = 'italic';
                item.style.color = '#28a745';
            }
            
            cfopSuggestionsContainer.appendChild(item);
        });
        
        cfopSelectedIndex = -1;
    }

    // Fun√ß√£o para mostrar container de sugest√µes CFOP
    function showCfopSuggestionsContainer() {
        cfopSuggestionsContainer.style.display = 'block';
    }

    // Fun√ß√£o para esconder container de sugest√µes CFOP
    function hideCfopSuggestions() {
        cfopSuggestionsContainer.style.display = 'none';
        cfopSelectedIndex = -1;
    }

    // Event listeners para CFOP
    if (cfopInput) {
        cfopInput.addEventListener('input', function() {
            showCfopSuggestions(this.value);
        });
        
        cfopInput.addEventListener('focus', function() {
            showCfopSuggestions(this.value);
        });
        
        cfopInput.addEventListener('blur', function() {
            setTimeout(() => {
                hideCfopSuggestions();
            }, 200);
        });
    }

    // Event listener para cliques nas sugest√µes CFOP
    if (cfopSuggestionsContainer) {
        cfopSuggestionsContainer.addEventListener('click', function(e) {
            const item = e.target.closest('.cfop-suggestion');
            if (item) {
                const index = parseInt(item.dataset.index);
                const suggestion = cfopSuggestions[index];
                
                if (suggestion.isNew) {
                    novoCfopCodigo.value = suggestion.originalText;
                    novoCfopModal.show();
                } else {
                    cfopInput.value = suggestion.text;
                    hideCfopSuggestions();
                }
            }
        });
    }

    // Bot√£o para adicionar novo CFOP
    if (adicionarNovoCfopBtn) {
        adicionarNovoCfopBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            hideCfopSuggestions();
            novoCfopCodigo.value = cfopInput.value || '';
            novoCfopModal.show();
        });
    }

    // Salvar novo CFOP
    if (salvarNovoCfopBtn) {
        salvarNovoCfopBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const codigo = novoCfopCodigo.value.trim();
            const descricao = novoCfopDescricao.value.trim();
            
            if (codigo && descricao) {
                const novoCfop = `${codigo} - ${descricao}`;
                
                if (!cfopsExistentes.includes(novoCfop)) {
                    cfopsExistentes.push(novoCfop);
                }
                
                cfopInput.value = novoCfop;
                novoCfopModal.hide();
                novoCfopCodigo.value = '';
                novoCfopDescricao.value = '';
                
                cfopInput.style.borderColor = '#28a745';
                setTimeout(() => {
                    cfopInput.style.borderColor = '';
                }, 1000);
                
                hideCfopSuggestions();
            }
        });
    }

    // ===== SISTEMA DE AUTOCOMPLETE PARA CST =====
    let cstSelectedIndex = -1;
    let cstSuggestions = [];

    // Fun√ß√£o para mostrar sugest√µes CST
    function showCstSuggestions(query) {
        if (!query || query.length < 1) {
            cstSuggestions = cstsExistentes.map(cst => ({
                text: cst,
                isNew: false,
                originalText: cst
            }));
            cstSuggestions.push({
                text: 'Criar novo CST...',
                isNew: true,
                originalText: ''
            });
        } else {
            const filteredCsts = cstsExistentes.filter(cst => 
                cst.toLowerCase().includes(query.toLowerCase())
            );
            
            cstSuggestions = filteredCsts.map(cst => ({
                text: cst,
                isNew: false,
                originalText: cst
            }));
            
            if (cstSuggestions.length === 0) {
                cstSuggestions = [{
                    text: `Criar "${query}"`,
                    isNew: true,
                    originalText: query
                }];
            } else {
                cstSuggestions.push({
                    text: `Criar "${query}"`,
                    isNew: true,
                    originalText: query
                });
            }
        }
        
        renderCstSuggestions();
        showCstSuggestionsContainer();
    }

    // Fun√ß√£o para renderizar sugest√µes CST
    function renderCstSuggestions() {
        cstSuggestionsContainer.innerHTML = '';
        
        cstSuggestions.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'cst-suggestion';
            item.dataset.index = index;
            
            const icon = document.createElement('i');
            icon.className = suggestion.isNew ? 'fas fa-plus me-2' : 'fas fa-percentage me-2';
            
            const text = document.createElement('span');
            text.textContent = suggestion.text;
            
            item.appendChild(icon);
            item.appendChild(text);
            
            if (suggestion.isNew) {
                item.style.fontStyle = 'italic';
                item.style.color = '#28a745';
            }
            
            cstSuggestionsContainer.appendChild(item);
        });
        
        cstSelectedIndex = -1;
    }

    // Fun√ß√£o para mostrar container de sugest√µes CST
    function showCstSuggestionsContainer() {
        cstSuggestionsContainer.style.display = 'block';
    }

    // Fun√ß√£o para esconder container de sugest√µes CST
    function hideCstSuggestions() {
        cstSuggestionsContainer.style.display = 'none';
        cstSelectedIndex = -1;
    }

    // Event listeners para CST
    if (cstInput) {
        cstInput.addEventListener('input', function() {
            showCstSuggestions(this.value);
        });
        
        cstInput.addEventListener('focus', function() {
            showCstSuggestions(this.value);
        });
        
        cstInput.addEventListener('blur', function() {
            setTimeout(() => {
                hideCstSuggestions();
            }, 200);
        });
    }

    // Event listener para cliques nas sugest√µes CST
    if (cstSuggestionsContainer) {
        cstSuggestionsContainer.addEventListener('click', function(e) {
            const item = e.target.closest('.cst-suggestion');
            if (item) {
                const index = parseInt(item.dataset.index);
                const suggestion = cstSuggestions[index];
                
                if (suggestion.isNew) {
                    novoCstCodigo.value = suggestion.originalText;
                    novoCstModal.show();
                } else {
                    cstInput.value = suggestion.text;
                    hideCstSuggestions();
                }
            }
        });
    }

    // Bot√£o para adicionar novo CST
    if (adicionarNovoCstBtn) {
        adicionarNovoCstBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            hideCstSuggestions();
            novoCstCodigo.value = cstInput.value || '';
            novoCstModal.show();
        });
    }

    // Salvar novo CST
    if (salvarNovoCstBtn) {
        salvarNovoCstBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const codigo = novoCstCodigo.value.trim();
            const descricao = novoCstDescricao.value.trim();
            
            if (codigo && descricao) {
                const novoCst = `${codigo} - ${descricao}`;
                
                if (!cstsExistentes.includes(novoCst)) {
                    cstsExistentes.push(novoCst);
                }
                
                cstInput.value = novoCst;
                novoCstModal.hide();
                novoCstCodigo.value = '';
                novoCstDescricao.value = '';
                
                cstInput.style.borderColor = '#28a745';
                setTimeout(() => {
                    cstInput.style.borderColor = '';
                }, 1000);
                
                hideCstSuggestions();
            }
        });
    }
    
    // ===== SISTEMA DE AUTOCOMPLETE PARA FORNECEDORES =====
    let fornecedorSelectedIndex = -1;
    let fornecedorSuggestions = [];

    // Fun√ß√£o para mostrar sugest√µes de fornecedores
    function showFornecedorSuggestions(query) {
        if (!query || query.length < 1) {
            fornecedorSuggestions = fornecedoresExistentes.map(fornecedor => ({
                text: fornecedor,
                isNew: false,
                originalText: fornecedor
            }));
            fornecedorSuggestions.push({
                text: 'Criar novo fornecedor...',
                isNew: true,
                originalText: ''
            });
        } else {
            const filteredFornecedores = fornecedoresExistentes.filter(fornecedor => 
                fornecedor.toLowerCase().includes(query.toLowerCase())
            );
            
            fornecedorSuggestions = filteredFornecedores.map(fornecedor => ({
                text: fornecedor,
                isNew: false,
                originalText: fornecedor
            }));
            
            if (fornecedorSuggestions.length === 0) {
                fornecedorSuggestions = [{
                    text: `Criar "${query}"`,
                    isNew: true,
                    originalText: query
                }];
            } else {
                fornecedorSuggestions.push({
                    text: `Criar "${query}"`,
                    isNew: true,
                    originalText: query
                });
            }
        }
        
        renderFornecedorSuggestions();
        showFornecedorSuggestionsContainer();
    }

    // Fun√ß√£o para renderizar sugest√µes de fornecedores
    function renderFornecedorSuggestions() {
        fornecedorSuggestionsContainer.innerHTML = '';
        
        fornecedorSuggestions.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'fornecedor-suggestion';
            item.dataset.index = index;
            
            const icon = document.createElement('i');
            icon.className = suggestion.isNew ? 'fas fa-plus me-2' : 'fas fa-building me-2';
            
            const text = document.createElement('span');
            text.textContent = suggestion.text;
            
            item.appendChild(icon);
            item.appendChild(text);
            
            if (suggestion.isNew) {
                item.style.fontStyle = 'italic';
                item.style.color = '#28a745';
            }
            
            fornecedorSuggestionsContainer.appendChild(item);
        });
        
        fornecedorSelectedIndex = -1;
    }

    // Fun√ß√£o para mostrar container de sugest√µes de fornecedores
    function showFornecedorSuggestionsContainer() {
        fornecedorSuggestionsContainer.style.display = 'block';
    }

    // Fun√ß√£o para esconder container de sugest√µes de fornecedores
    function hideFornecedorSuggestions() {
        fornecedorSuggestionsContainer.style.display = 'none';
        fornecedorSelectedIndex = -1;
    }

    // Event listeners para fornecedores
    if (fornecedorInput) {
        fornecedorInput.addEventListener('input', function() {
            showFornecedorSuggestions(this.value);
        });
        
        fornecedorInput.addEventListener('focus', function() {
            showFornecedorSuggestions(this.value);
        });
        
        fornecedorInput.addEventListener('blur', function() {
            // Delay para permitir cliques nas sugest√µes
            setTimeout(() => {
                hideFornecedorSuggestions();
            }, 200);
        });
    }

    // Event listener para cliques nas sugest√µes de fornecedores
    if (fornecedorSuggestionsContainer) {
        fornecedorSuggestionsContainer.addEventListener('click', function(e) {
            const item = e.target.closest('.fornecedor-suggestion');
            if (item) {
                const index = parseInt(item.dataset.index);
                const suggestion = fornecedorSuggestions[index];
                
                if (suggestion.isNew) {
                    novoFornecedorNome.value = suggestion.originalText;
                    novoFornecedorModal.show();
                } else {
                    fornecedorInput.value = suggestion.text;
                    hideFornecedorSuggestions();
                }
            }
        });
    }

    // Bot√£o para adicionar novo fornecedor
    if (adicionarNovoFornecedorBtn) {
        adicionarNovoFornecedorBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            hideFornecedorSuggestions();
            novoFornecedorNome.value = fornecedorInput.value || '';
            novoFornecedorModal.show();
        });
    }

    // Salvar novo fornecedor
    if (salvarNovoFornecedorBtn) {
        salvarNovoFornecedorBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const nome = novoFornecedorNome.value.trim();
            const cnpj = novoFornecedorCnpj.value.trim();
            const contato = novoFornecedorContato.value.trim();
            const telefone = novoFornecedorTelefone.value.trim();
            const email = novoFornecedorEmail.value.trim();
            
            if (nome) {
                try {
                    // Salvar fornecedor no backend
                    const response = await fetch('/api/fornecedores', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            nome: nome,
                            cnpj: cnpj,
                            contato: contato,
                            telefone: telefone,
                            email: email
                        })
                    });
                    
                    if (response.ok) {
                        // Adicionar √† lista local
                        if (!fornecedoresExistentes.includes(nome)) {
                            fornecedoresExistentes.push(nome);
                        }
                        
                        // Preencher o campo
                        fornecedorInput.value = nome;
                        
                        // Fechar modal e limpar campos
                        novoFornecedorModal.hide();
                        novoFornecedorNome.value = '';
                        novoFornecedorCnpj.value = '';
                        novoFornecedorContato.value = '';
                        novoFornecedorTelefone.value = '';
                        novoFornecedorEmail.value = '';
                        
                        // Feedback visual
                        fornecedorInput.style.borderColor = '#28a745';
                        setTimeout(() => {
                            fornecedorInput.style.borderColor = '';
                        }, 1000);
                        
                        hideFornecedorSuggestions();
                    } else {
                        alert('Erro ao salvar fornecedor. Tente novamente.');
                    }
                } catch (error) {
                    console.error('Erro ao salvar fornecedor:', error);
                    alert('Erro ao salvar fornecedor. Tente novamente.');
                }
            }
        });
    }
    
    // Event listeners para modal de nova categoria
    if (adicionarNovaCategoriaBtn) {
        adicionarNovaCategoriaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            categoriaSuggestions.style.display = 'none';
            novaCategoriaNomeInput.value = categoriaInput.value || '';
            novaCategoriaModal.style.display = 'block';
            novaCategoriaModal.classList.add('show');
            document.body.classList.add('modal-open');
            
            setTimeout(() => {
                novaCategoriaNomeInput.focus();
                novaCategoriaNomeInput.select();
            }, 100);
        });
    }
    
    if (salvarNovaCategoriaBtn) {
        salvarNovaCategoriaBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const novaCategoria = novaCategoriaNomeInput.value.trim();
            if (novaCategoria) {
                categoriaInput.value = novaCategoria;
                if (!categoriasExistentes.includes(novaCategoria)) {
                    categoriasExistentes.push(novaCategoria);
                }
                categoriaSuggestions.style.display = 'none';
                
                // Salvar no backend e recarregar categorias
                try {
                    const response = await fetch('/api/categorias', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ categoria: novaCategoria })
                    });
                    
                    if (response.ok) {
                        // Recarregar categorias do backend
                        await carregarCategorias();
                        
                        // Notificar outras abas sobre a nova categoria
                        window.dispatchEvent(new CustomEvent('categoriaCriada', { 
                            detail: { categoria: novaCategoria } 
                        }));
                    }
                } catch (error) {
                    console.log('Erro ao salvar categoria no backend:', error);
                }
            }
            
            novaCategoriaModal.style.display = 'none';
            novaCategoriaModal.classList.remove('show');
            document.body.classList.remove('modal-open');
            novaCategoriaNomeInput.value = '';
            categoriaInput.focus();
        });
    }
    
    if (novaCategoriaNomeInput) {
        novaCategoriaNomeInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                salvarNovaCategoriaBtn.click();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                e.stopPropagation();
                novaCategoriaModal.style.display = 'none';
                novaCategoriaModal.classList.remove('show');
                document.body.classList.remove('modal-open');
                novaCategoriaNomeInput.value = '';
                categoriaInput.focus();
            }
        });
    }
    
    // Event listeners do modal
    if (novaCategoriaModal) {
        novaCategoriaModal.addEventListener('shown.bs.modal', function() {
            novaCategoriaNomeInput.focus();
            novaCategoriaNomeInput.select();
            document.body.style.overflow = 'hidden';
            document.body.style.paddingRight = '0px';
            document.body.classList.add('modal-open');
        });
        
        novaCategoriaModal.addEventListener('hidden.bs.modal', function() {
            novaCategoriaNomeInput.value = '';
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            document.body.classList.remove('modal-open');
        });
        
        novaCategoriaModal.addEventListener('show.bs.modal', function() {
            document.body.style.pointerEvents = 'auto';
        });
    }

    // Valida√ß√£o do formul√°rio
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const nome = document.getElementById('nome').value.trim();
            const preco = document.getElementById('preco_unitario').value;
            
            if (!nome) {
                e.preventDefault();
                alert('Por favor, preencha o nome do produto auxiliar.');
                document.getElementById('nome').focus();
                return false;
            }
            
            if (!preco || parseFloat(preco.replace(',', '.')) < 0) {
                e.preventDefault();
                alert('Por favor, insira um pre√ßo v√°lido.');
                document.getElementById('preco_unitario').focus();
                return false;
            }
        });
    }

    // Funcionalidade da sidebar fixa
    const sidebar = document.querySelector('.sticky-sidebar');
    if (sidebar) {
        // Adicionar classe quando a sidebar est√° fixa
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    sidebar.classList.remove('sticky');
                } else {
                    sidebar.classList.add('sticky');
                }
            });
        }, {
            rootMargin: '-20px 0px 0px 0px'
        });

        // Observar o in√≠cio da sidebar
        const sidebarTop = sidebar.offsetTop;
        const trigger = document.createElement('div');
        trigger.style.position = 'absolute';
        trigger.style.top = (sidebarTop - 20) + 'px';
        trigger.style.height = '1px';
        trigger.style.width = '100%';
        trigger.style.pointerEvents = 'none';
        document.body.appendChild(trigger);
        
        observer.observe(trigger);
    }
});
</script>
{% endblock %}