{% extends 'layout/base.html' %}
{% block content %}
<h2>Pré-visualização de Importação de Movimentos</h2>
<p>Total de linhas detectadas: {{ total_rows }}. Mapeie as colunas para os campos do sistema e confirme para importar.</p>

<form method="post" action="{{ url_for('confirmar_importacao_movimentos_caixa', sessao_id=sessao.id) }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="row">
    <div class="col-md-6">
      <label>Tipo (entrada/saida)</label>
      <select class="form-control" name="map_tipo" required>
        <option value="">Selecione…</option>
        {% for h in headers %}
          <option value="{{ h }}" {% if default_map.tipo == h %}selected{% endif %}>{{ h }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6">
      <label>Origem (venda/suprimento/sangria/ajuste)</label>
      <select class="form-control" name="map_origem" required>
        <option value="">Selecione…</option>
        {% for h in headers %}
          <option value="{{ h }}" {% if default_map.origem == h %}selected{% endif %}>{{ h }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="row mt-2">
    <div class="col-md-6">
      <label>Valor</label>
      <select class="form-control" name="map_valor" required>
        <option value="">Selecione…</option>
        {% for h in headers %}
          <option value="{{ h }}" {% if default_map.valor == h %}selected{% endif %}>{{ h }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6">
      <label>Descrição</label>
      <select class="form-control" name="map_descricao">
        <option value="">Selecione…</option>
        {% for h in headers %}
          <option value="{{ h }}" {% if default_map.descricao == h %}selected{% endif %}>{{ h }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="row mt-2">
    <div class="col-md-6">
      <label>Forma de pagamento</label>
      <select class="form-control" name="map_forma_pagamento">
        <option value="">Selecione…</option>
        {% for h in headers %}
          <option value="{{ h }}" {% if default_map.forma_pagamento == h %}selected{% endif %}>{{ h }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6">
      <label>Referência (ID)</label>
      <select class="form-control" name="map_referencia_id">
        <option value="">Selecione…</option>
        {% for h in headers %}
          <option value="{{ h }}" {% if default_map.referencia_id == h %}selected{% endif %}>{{ h }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="row mt-2">
    <div class="col-md-6">
      <label>Data (opcional)</label>
      <select class="form-control" name="map_data">
        <option value="">Selecione…</option>
        {% for h in headers %}
          <option value="{{ h }}" {% if default_map.data == h %}selected{% endif %}>{{ h }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="mt-3">
    <button type="submit" class="btn btn-primary">Confirmar Importação</button>
    <a href="{{ url_for('caixa_sessao_detalhes', sessao_id=sessao.id) }}" class="btn btn-secondary">Cancelar</a>
  </div>
</form>

<hr>
<h3>Pré-visualização (primeiras {{ rows|length }} linhas)</h3>
<div class="table-responsive">
  <table class="table table-striped table-sm">
    <thead>
      <tr>
        {% for h in headers %}<th>{{ h }}</th>{% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
        <tr>
          {% for h in headers %}
            <td>{{ r[h] }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<p class="text-muted">Observação: Linhas inválidas serão rejeitadas na confirmação e contabilizadas em um log de rejeições.</p>
{% endblock %}